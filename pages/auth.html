<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Вход - Insight Room</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles/auth.css') }}">
</head>
<body>
    <div class="animated-bg"></div>
    
    <header class="header">
        <div class="container">
            <div class="logo">
                <a href="/" class="logo-link">Insight Room</a>
            </div>
            <nav class="nav">
                <a href="/" class="login-btn">На главную</a>
            </nav>
        </div>
    </header>

    <main class="main">
        <div class="container auth-container">
            <div class="auth-card">
                <a href="/" class="back-home">← Назад</a>
                <h1 class="auth-title">Добро пожаловать!</h1>
                
                <div class="auth-tabs">
                    <button class="auth-tab active" onclick="showForm('login')">Вход</button>
                    <button class="auth-tab" onclick="showForm('register')">Регистрация</button>
                </div>

                <!-- Форма входа -->
                <form id="loginForm" class="auth-form active">
                    <div class="auth-method-selector">
                        <label class="form-label">Способ входа</label>
                        <select class="method-select" id="loginMethod">
                            <option value="login">Логин</option>
                            <option value="email">Email</option>
                            <option value="phone">Телефон</option>
                        </select>
                    </div>

                    <div class="method-input-group active" id="loginInput">
                        <label class="form-label">Логин</label>
                        <input type="text" class="form-input" placeholder="Ваш логин" id="loginField">
                    </div>

                    <div class="method-input-group" id="emailInput">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-input" placeholder="your@email.com" id="emailField">
                    </div>

                    <div class="method-input-group" id="phoneInput">
                        <label class="form-label">Телефон</label>
                        <input type="tel" class="form-input" placeholder="+7-000-000-00-00" id="phoneField">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Пароль</label>
                        <input type="password" class="form-input" placeholder="Введите пароль" id="passwordField" required>
                    </div>

                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="rememberMe"> Запомнить меня
                        </label>
                    </div>

                    <button type="submit" class="auth-btn" id="loginBtn">Войти</button>

                    <div class="auth-footer">
                        <a href="#" class="auth-link">Забыли пароль?</a>
                    </div>
                </form>

                <!-- Форма регистрации -->
                <form id="registerForm" class="auth-form">
                    <div class="form-group">
                        <label class="form-label">Имя</label>
                        <input id="username" type="text" class="form-input" placeholder="Ваше имя" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Логин</label>
                        <input id="login" type="text" class="form-input" placeholder="Ваш логин" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input id="email" type="email" class="form-input" placeholder="your@email.com" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Телефон</label>
                        <input id="tel" type="tel" class="form-input" placeholder="+7-000-000-00-00">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Пароль</label>
                        <input id="password" type="password" class="form-input" placeholder="Не менее 8 символов" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Подтвердите пароль</label>
                        <input id="confirmPassword" type="password" class="form-input" placeholder="Повторите пароль" required>
                    </div>

                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="agreeTerms" required> 
                            Я согласен с <a href="#" class="auth-link">условиями использования</a>
                        </label>
                    </div>

                    <button type="submit" class="auth-btn" id="submitBtn">Создать аккаунт</button>
                </form>
            </div>
        </div>
    </main>

    <script src="{{ url_for('static', filename='JS/auth.js') }}"></script>
    <script>
        function showForm(formType) {
            // Обновляем активные табы
            document.querySelectorAll('.auth-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');

            // Показываем активную форму
            document.querySelectorAll('.auth-form').forEach(form => {
                form.classList.remove('active');
            });
            document.getElementById(formType + 'Form').classList.add('active');
        }

        // функция для переключения полей входа
        function setupAuthMethodSelector() {
            const methodSelect = document.getElementById('loginMethod');
            const loginInput = document.getElementById('loginInput');
            const emailInput = document.getElementById('emailInput');
            const phoneInput = document.getElementById('phoneInput');
            
            methodSelect.addEventListener('change', function() {
                [loginInput, emailInput, phoneInput].forEach(input => {
                    input.classList.remove('active');
                });
                
                switch(this.value) {
                    case 'login':
                        loginInput.classList.add('active');
                        break;
                    case 'email':
                        emailInput.classList.add('active');
                        break;
                    case 'phone':
                        phoneInput.classList.add('active');
                        break;
                }
            });
        }

        // Обработка формы входа
        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const loginBtn = document.getElementById('loginBtn');
            const method = document.getElementById('loginMethod').value;
            const password = document.getElementById('passwordField').value;
            let identifier = false;
            let login_info = {};
            
            // Блокируем кнопку
            loginBtn.disabled = true;
            loginBtn.textContent = 'Вход...';
            
            switch(method) {
                case 'login':
                    login_info.login = document.getElementById('loginField').value;
                    identifier = login_info.login;
                    break;
                case 'email':
                    login_info.email = document.getElementById('emailField').value;
                    identifier = login_info.email;
                    break;
                case 'phone':
                    login_info.phone = document.getElementById('phoneField').value;
                    identifier = login_info.phone;
                    break;
            }
            
            if (!password) {
                alert('Пожалуйста, введите пароль');
                loginBtn.disabled = false;
                loginBtn.textContent = 'Войти';
                return;
            } else {
                login_info.password = password;
            }
            
            if (!identifier) {
                alert('Пожалуйста, заполните поле для входа');
                loginBtn.disabled = false;
                loginBtn.textContent = 'Войти';
                return;
            }

            // Добавляем remember_me если нужно
            const rememberMe = document.getElementById('rememberMe').checked;
            if (rememberMe) {
                login_info.remember_me = true;
            }

            try {
                // Авторизация
                const ans = await authService.login(login_info);
                if (ans !== true){
                    console.log(ans)
                    alert(ans);
                    loginBtn.disabled = false;
                    loginBtn.textContent = 'Войти';
                } else {
                    // Успешный вход - перенаправляем
                    window.location.href = '/cabinet';
                }
            } catch (error) {
                console.error('Ошибка входа:', error);
                alert('Произошла ошибка при входе');
                loginBtn.disabled = false;
                loginBtn.textContent = 'Войти';
            }
        });

        // Обработка регистрации
        document.getElementById('registerForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const submitBtn = document.getElementById('submitBtn');
            const username = document.getElementById('username').value;
            const login = document.getElementById('login').value;
            const email = document.getElementById('email').value;
            const tel = document.getElementById('tel').value;
            const password = document.getElementById('password').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            // Валидация
            if (password !== confirmPassword) {
                alert('Пароли не совпадают!');
                return;
            }
            
            if (password.length < 8) {
                alert('Пароль должен содержать не менее 8 символов');
                return;
            }
            
            if (!document.getElementById('agreeTerms').checked) {
                alert('Необходимо согласие с условиями использования');
                return;
            }
            
            submitBtn.disabled = true;
            submitBtn.textContent = 'Регистрация...';
            
            const new_user = {
                username: username,
                login: login,
                email: email,
                tel: tel,
                password: password
            };

            try {
                const ans = await authService.register(new_user);
                if (ans !== true){
                    alert(ans);
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Создать аккаунт';
                } else {
                    window.location.href = '/cabinet';
                }
            } catch (error) {
                console.error('Ошибка регистрации:', error);
                alert('Произошла ошибка при регистрации');
                submitBtn.disabled = false;
                submitBtn.textContent = 'Создать аккаунт';
            }
        });

        // Проверка аутентификации при загрузке
        document.addEventListener('DOMContentLoaded', function() {
            setupAuthMethodSelector();
            
            // Если пользователь уже авторизован, перенаправляем на главную
            if (authService.isAuthenticated()) {
                window.location.href = '/cabinet';
            }
        });

        // Функция для показа/скрытия уведомлений
        function showNotification(message, type = 'error') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                border-radius: 5px;
                color: white;
                z-index: 10000;
                font-weight: 500;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                transition: all 0.3s ease;
                max-width: 400px;
            `;
            
            if (type === 'error') {
                notification.style.background = '#ff4757';
            } else {
                notification.style.background = '#2ed573';
            }
            
            notification.textContent = message;
            document.body.appendChild(notification);
            
            // Автоматическое скрытие через 5 секунд
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(100px)';
                setTimeout(() => {
                    if (document.body.contains(notification)) {
                        document.body.removeChild(notification);
                    }
                }, 300);
            }, 5000);
        }
    </script>
</body>
</html>