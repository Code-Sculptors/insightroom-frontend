<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Личный кабинет - Insight Room</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles/personal-cabinet.css') }}">
    
</head>
<body>
    <div class="animated-bg"></div>
    
    <header class="header">
        <div class="container">
            <div class="logo">
                <a href="/" class="logo-link">Insight Room</a>
            </div>
            
            <nav class="nav">
                <div class="user-menu">
                    <button class="settings-btn" onclick="toggleSettings()">
                        <img src="{{ url_for('static', filename='images/settings-icon.png') }}" alt="Настройки">
                    </button>
                    
                    <div class="user-info">
                        <span class="user-name">{{ user_name }}</span>
                        <span class="user-login">{{ user_login }}</span>
                    </div>
                    <button class="logout-btn" onclick="handleLogout()">Выйти</button>
                </div>
            </nav>

            <div id="settingsDropdown" class="settings-dropdown">
                <div class="settings-section">
                    <h4>Тема</h4>
                    <div class="theme-switcher">
                        <button class="theme-option active" data-theme="light" onclick="changeTheme('light')">
                            Светлая
                        </button>
                        <button class="theme-option" data-theme="dark" onclick="changeTheme('dark')">
                            Темная
                        </button>
                        <button class="theme-option" data-theme="auto" onclick="changeTheme('auto')">
                            Авто
                        </button>
                    </div>
                </div>
                
                <div class="settings-section">
                    <h4>Конфиденциальность</h4>
                    <div class="privacy-setting">
                        <label>Номер телефона</label>
                        <select class="privacy-select" onchange="updatePrivacySetting('phone', this.value)">
                            <option value="everyone">Все</option>
                            <option value="contacts">Только контакты</option>
                            <option value="nobody">Никто</option>
                        </select>
                    </div>
                    <div class="privacy-setting">
                        <label>Фото профиля</label>
                        <select class="privacy-select" onchange="updatePrivacySetting('photo', this.value)">
                            <option value="everyone">Все</option>
                            <option value="contacts">Только контакты</option>
                            <option value="nobody">Никто</option>
                        </select>
                    </div>
                    <div class="privacy-setting">
                        <label>Email</label>
                        <select class="privacy-select" onchange="updatePrivacySetting('email', this.value)">
                            <option value="everyone">Все</option>
                            <option value="contacts">Только контакты</option>
                            <option value="nobody">Никто</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <main class="main">
        <div class="container dashboard-container">
            <div class="dashboard-header">
                <h1 class="dashboard-title">Личный кабинет</h1>
                <p class="dashboard-subtitle">Добро пожаловать, {{ user_name }}</p>
            </div>

            <div class="dashboard-layout">
                <div class="dashboard-main">
                    <!-- Активные сессии (объединенные встречи) -->
                    <section class="dashboard-section">
                        <div class="section-header">
                            <div class="section-title">
                                <img src="{{ url_for('static', filename='images/calendar-icon.png') }}" alt="Сессии" class="section-icon">
                                <h2>Активные сессии</h2>
                            </div>
                            <span class="section-count">{{ sessions_count }}</span>
                        </div>
                        
                        <!-- Текущие встречи (онлайн) -->
                        <div class="session-group">
                            <h3 class="session-group-title">Текущие встречи</h3>
                            <div class="compact-list">
                                {% for meeting in current_meetings %}
                                <div class="list-item">
                                    <div class="item-main">
                                        <div class="item-header">
                                            <h3>{{ meeting.title }}</h3>
                                            <span class="session-badge live">LIVE</span>
                                        </div>
                                        <p class="item-meta">{{ meeting.time }} • ID: {{ meeting.id }}</p>
                                        <p class="session-type">Встреча • {{ meeting.participants }} участников</p>
                                    </div>
                                    <div class="item-actions">
                                        <form action="/join_meeting" method="POST" style="display: inline;">
                                            <input type="hidden" name="meeting_id" value="{{ meeting.id }}">
                                            <button type="submit" class="action-btn small primary">Присоединиться</button>
                                        </form>
                                        <button type="button" class="action-btn small secondary" onclick="copyMeetingLink('{{ meeting.id }}')">Ссылка</button>
                                    </div>
                                </div>
                                {% endfor %}
                                {% if not current_meetings %}
                                <div class="empty-state">
                                    <p>Нет активных встреч</p>
                                </div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Запланированные встречи -->
                        <div class="session-group">
                            <h3 class="session-group-title">Запланированные встречи</h3>
                            <div class="compact-list">
                                {% for meeting in scheduled_meetings %}
                                <div class="list-item">
                                    <div class="item-main">
                                        <div class="item-header">
                                            <h3>{{ meeting.title }}</h3>
                                            <span class="session-badge upcoming">Запланировано</span>
                                        </div>
                                        <p class="item-meta">{{ meeting.date }} в {{ meeting.time }} • ID: {{ meeting.id }}</p>
                                        <p class="session-type">Встреча</p>
                                    </div>
                                    <div class="item-actions">
                                        <button type="button" class="action-btn small secondary" onclick="copyMeetingLink('{{ meeting.id }}')">Ссылка</button>
                                        <button type="button" class="action-btn small secondary" onclick="cancelMeeting('{{ meeting.id }}')">Отменить</button>
                                    </div>
                                </div>
                                {% endfor %}
                                {% if not scheduled_meetings %}
                                <div class="empty-state">
                                    <p>Нет запланированных встреч</p>
                                </div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="section-footer">
                            <button type="button" class="text-btn" onclick="openScheduleModal()">+ Запланировать встречу</button>
                            <button type="button" class="text-btn" onclick="openCreateRoomModal()" style="margin-left: 15px;">+ Создать комнату</button>
                        </div>
                    </section>
                </div>

                <!-- Боковая панель -->
                <div class="dashboard-sidebar">
                    <!-- Быстрый доступ -->
                    <section class="sidebar-section">
                        <div class="section-header">
                            <div class="section-title">
                                <img src="{{ url_for('static', filename='images/actions-icon.png') }}" alt="Действия" class="section-icon">
                                <h3>Быстрый доступ</h3>
                            </div>
                        </div>
                        <div class="quick-actions-compact">
                            <form action="/create_meeting" method="POST" class="quick-action-form">
                                <button type="submit" class="quick-action-btn">
                                    <img src="{{ url_for('static', filename='images/create-icon.png') }}" alt="Создать встречу" class="action-icon">
                                    <span>Новая встреча</span>
                                </button>
                            </form>
                            <button type="button" class="quick-action-btn" onclick="openJoinModal()">
                                <img src="{{ url_for('static', filename='images/join-icon.png') }}" alt="Присоединиться" class="action-icon">
                                <span>Присоединиться</span>
                            </button>
                        </div>
                    </section>

                    <!-- Контакты -->
                    <section class="sidebar-section">
                        <div class="section-header">
                            <div class="section-title">
                                <img src="{{ url_for('static', filename='images/contacts-icon.png') }}" alt="Контакты" class="section-icon">
                                <h3>Контакты</h3>
                            </div>
                            <span class="section-count">{{ contacts_count }}</span>
                        </div>
                        <div class="contacts-compact">
                            {% for contact in contacts %}
                            <div class="contact-item">
                                <div class="contact-avatar small">{{ contact.initials }}</div>
                                <div class="contact-info">
                                    <span class="contact-name">{{ contact.name }}</span>
                                    <span class="contact-email">{{ contact.email }}</span>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        <div class="section-footer">
                            <form action="/add_contact" method="POST" style="display: inline;">
                                <button type="submit" class="text-btn small">+ Добавить контакт</button>
                            </form>
                        </div>
                    </section>
                </div>
            </div>
        </div>
    </main>

    <!-- Модальное окно для планирования встречи -->
    <div id="scheduleModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Запланировать встречу</h2>
                <button class="close-btn" onclick="closeScheduleModal()">×</button>
            </div>
            <form id="scheduleForm" class="modal-form">
                <div class="form-group">
                    <label class="form-label">Название встречи</label>
                    <input type="text" class="form-input" id="meetingTitle" placeholder="Введите название встречи" required>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Дата</label>
                        <input type="date" class="form-input" id="meetingDate" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Время</label>
                        <input type="time" class="form-input" id="meetingTime" required>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Описание (необязательно)</label>
                    <textarea class="form-textarea" id="meetingDescription" placeholder="О чем будет встреча..."></textarea>
                </div>
                
                <button type="submit" class="modal-btn">Запланировать встречу</button>
            </form>
        </div>
    </div>

    <!-- Модальное окно для присоединения -->
    <div id="joinModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Присоединиться к встрече</h2>
                <button class="close-btn" onclick="closeJoinModal()">×</button>
            </div>
            <form id="joinForm" class="modal-form" action="/join_meeting" method="POST">
                <div class="form-group">
                    <label class="form-label">ID встречи или ссылка</label>
                    <input type="text" class="form-input" name="meeting_id" placeholder="Введите ID встречи или ссылку" required>
                </div>
                <button type="submit" class="modal-btn">Присоединиться</button>
            </form>
        </div>
    </div>

    <!-- Модальное окно для создания комнаты -->
    <div id="createRoomModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Создать комнату</h2>
                <button class="close-btn" onclick="closeCreateRoomModal()">×</button>
            </div>
            <form id="createRoomForm" class="modal-form" action="/create_room" method="POST">
                <div class="form-group">
                    <label class="form-label">Название комнаты</label>
                    <input type="text" class="form-input" name="room_name" placeholder="Введите название комнаты" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Описание (необязательно)</label>
                    <textarea class="form-textarea" name="room_description" placeholder="Опишите назначение комнаты..."></textarea>
                </div>
                
                <button type="submit" class="modal-btn">Создать комнату</button>
            </form>
        </div>
    </div>

    <script src="{{ url_for('static', filename='JS/auth.js') }}"></script>

    <footer class="footer">
        <div class="container">
            <p>&copy; 2025 Insight Room. Все права защищены.</p>
        </div>
    </footer>

    <script>
        // Функция для логирования данных формы
        function logFormData(formData, formType) {
            console.log('=== ДАННЫЕ ФОРМЫ ===');
            console.log('Тип формы:', formType);
            console.log('Введенные параметры:');
            
            for (let [key, value] of formData.entries()) {
                console.log(`  ${key}: ${value}`);
            }
            
            console.log('Временная метка:', new Date().toISOString());
            console.log('================================');
        }

        // Функции для работы с модальными окнами
        function openScheduleModal() {
            const modal = document.getElementById('scheduleModal');
            modal.classList.add('show');
            
            // Устанавливаем минимальную дату - сегодня
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('meetingDate').min = today;
        }

        function closeScheduleModal() {
            const modal = document.getElementById('scheduleModal');
            modal.classList.remove('show');
        }

        function openJoinModal() {
            const modal = document.getElementById('joinModal');
            modal.classList.add('show');
        }

        function closeJoinModal() {
            const modal = document.getElementById('joinModal');
            modal.classList.remove('show');
        }

        function openCreateRoomModal() {
            const modal = document.getElementById('createRoomModal');
            modal.classList.add('show');
        }

        function closeCreateRoomModal() {
            const modal = document.getElementById('createRoomModal');
            modal.classList.remove('show');
        }

        // Закрытие модальных окон при клике вне их
        document.querySelectorAll('.modal-overlay').forEach(modal => {
            modal.addEventListener('click', function(e) {
                if (e.target === this) {
                    this.classList.remove('show');
                }
            });
        });

        // Обработка формы планирования встречи
        document.getElementById('scheduleForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData();
            formData.append('meeting_title', document.getElementById('meetingTitle').value);
            formData.append('meeting_date', document.getElementById('meetingDate').value);
            formData.append('meeting_time', document.getElementById('meetingTime').value);
            formData.append('meeting_description', document.getElementById('meetingDescription').value);
            
            // Логирование данных
            logFormData(formData, 'Планирование встречи');
            
            console.log('Данные встречи:', {
                meeting_title: document.getElementById('meetingTitle').value,
                meeting_date: document.getElementById('meetingDate').value,
                meeting_time: document.getElementById('meetingTime').value,
                meeting_description: document.getElementById('meetingDescription').value
            });
            alert('Встреча запланирована!');
            closeScheduleModal();
            
            // Очищаем форму
            this.reset();
        });

        // Обработка формы присоединения к встрече
        document.getElementById('joinForm').addEventListener('submit', function(e) {
            const formData = new FormData(this);
            
            // Логирование данных
            logFormData(formData, 'Присоединение к встрече');
        });

        // Обработка формы создания комнаты
        document.getElementById('createRoomForm').addEventListener('submit', function(e) {
            const formData = new FormData(this);
            
            // Логирование данных
            logFormData(formData, 'Создание комнаты');
        });

        // Вспомогательные функции
        function copyMeetingLink(meetingId) {
            const link = `${window.location.origin}/join/${meetingId}`;
            
            console.log('=== КОПИРОВАНИЕ ССЫЛКИ ===');
            console.log('meeting_id:', meetingId);
            console.log('meeting_link:', link);
            console.log('Временная метка:', new Date().toISOString());
            console.log('==========================');
            
            navigator.clipboard.writeText(link).then(() => {
                alert('Ссылка скопирована в буфер обмена!');
            });
        }

        function cancelMeeting(meetingId) {
            console.log('=== ОТМЕНА ВСТРЕЧИ ===');
            console.log('meeting_id:', meetingId);
            console.log('Временная метка:', new Date().toISOString());
            console.log('======================');
            
            if (confirm('Вы уверены, что хотите отменить эту встречу?')) {
                console.log('Отмена встречи:', meetingId);
                alert('Встреча отменена');
            }
        }

        // Функции для работы с настройками
        function toggleSettings() {
            const dropdown = document.getElementById('settingsDropdown');
            dropdown.classList.toggle('show');
        }

        // Закрытие меню настроек при клике вне его
        document.addEventListener('click', function(e) {
            const dropdown = document.getElementById('settingsDropdown');
            const settingsBtn = document.querySelector('.settings-btn');
            
            if (dropdown && settingsBtn && !dropdown.contains(e.target) && !settingsBtn.contains(e.target)) {
                dropdown.classList.remove('show');
            }
        });

        // Смена темы
        function changeTheme(theme) {
            document.body.className = '';
            document.body.classList.add(theme + '-theme');
            
            document.querySelectorAll('.theme-option').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-theme="${theme}"]`).classList.add('active');
            
            localStorage.setItem('theme', theme);
        }

        // Обновление настроек конфиденциальности
        function updatePrivacySetting(type, value) {
            console.log(`Настройка ${type} изменена на: ${value}`);
        }

        // Функция для выхода
        async function handleLogout() {
            try {
                await authService.logout();
            } catch (error) {
                console.error('Ошибка при выходе:', error);
            } finally {
                window.location.href = '/';
            }
        }

        // Проверка аутентификации при загрузке страницы
        document.addEventListener('DOMContentLoaded', function() {
            if (!authService.isAuthenticated()) {
                window.location.href = '/login';
                return;
            }

            // Загружаем тему
            const savedTheme = localStorage.getItem('theme') || 'light';
            changeTheme(savedTheme);

            setInterval(() => {
                if (!authService.isAuthenticated()) {
                    window.location.href = '/login';
                }
            }, 60000);
        });
    </script>
</body>
</html>